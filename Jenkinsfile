pipeline {
    agent any
    
    environment {
        // –ò–º—è –≤–∞—à–µ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (–∑–∞–º–µ–Ω–∏ –Ω–∞ —Å–≤–æ–µ)
        APP_NAME = 'DevOps_Lab1'
        
        // URL —Ç–≤–æ–µ–≥–æ GitHub —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è (–ó–ê–ú–ï–ù–ò –ù–ê –°–í–û–ô!)
        GIT_REPO_URL = 'https://github.com/GenkoKsenia/DevOps_calculator.git'
    }
    
    options {
        // –¢–∞–π–º–∞—É—Ç 30 –º–∏–Ω—É—Ç –Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤
        timeout(time: 30, unit: 'MINUTES')
    }
    
    stages {
        /*
         * –≠–¢–ê–ü 1: –ü–û–õ–£–ß–ï–ù–ò–ï –ö–û–î–ê –ò–ó GIT
         * Jenkins –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –≤–µ—Ç–∫—É –∏–∑ webhook-–∞
         */
        stage('Checkout Code from GitHub') {
            steps {
                echo "üì• –ü–æ–ª—É—á–∞–µ–º –∫–æ–¥ –∏–∑ GitHub —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è..."
                echo "üîó –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π: ${GIT_REPO_URL}"
                
                // –ö–æ–º–∞–Ω–¥–∞ checkout –ø–æ–ª—É—á–∞–µ—Ç –∫–æ–¥ –∏–∑ Git
                checkout([
                    $class: 'GitSCM',
                    branches: [[name: '*/dev']],  // –†–∞–±–æ—Ç–∞–µ–º —Å dev –≤–µ—Ç–∫–æ–π
                    extensions: [],
                    userRemoteConfigs: [[
                        url: "${GIT_REPO_URL}"
                    ]]
                ])
                
                // –í—ã–≤–æ–¥–∏–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–µ–∫—É—â–µ–º –∫–æ–º–º–∏—Ç–µ
                script {
                    // –ü–æ–ª—É—á–∞–µ–º —Ö—ç—à —Ç–µ–∫—É—â–µ–≥–æ –∫–æ–º–º–∏—Ç–∞
                    COMMIT_HASH = sh(
                        script: 'git rev-parse --short HEAD',
                        returnStdout: true
                    ).trim()
                    
                    // –ü–æ–ª—É—á–∞–µ–º –∞–≤—Ç–æ—Ä–∞ –∫–æ–º–º–∏—Ç–∞
                    COMMIT_AUTHOR = sh(
                        script: "git show -s --format='%ae' HEAD",
                        returnStdout: true
                    ).trim()
                    
                    echo "üîñ –¢–µ–∫—É—â–∏–π –∫–æ–º–º–∏—Ç: ${COMMIT_HASH}"
                    echo "üë§ –ê–≤—Ç–æ—Ä: ${COMMIT_AUTHOR}"
                }
            }
        }
        
        /*
         * –≠–¢–ê–ü 2: –ü–û–î–ì–û–¢–û–í–ö–ê –ó–ê–í–ò–°–ò–ú–û–°–¢–ï–ô
         * –≠—Ç–æ—Ç —ç—Ç–∞–ø –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ç–∏–ø–∞ —Ç–≤–æ–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞
         */
        stage('Install Dependencies') {
            steps {
                echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
                
                script {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø –ø—Ä–æ–µ–∫—Ç–∞ –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
                    sh 'pip install -r requirements.txt'
                }
            }
        }
        
        /*
         * –≠–¢–ê–ü 3: –ó–ê–ü–£–°–ö –¢–ï–°–¢–û–í
         * –ó–¥–µ—Å—å –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è —Ç–µ—Å—Ç—ã —Ç–≤–æ–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞
         */
        stage('Run Tests') {
            steps {
                echo "üß™ –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç—ã..."
                
                script {
                    try {        
                        // –î–ª—è Python –ø—Ä–æ–µ–∫—Ç–æ–≤
                        echo "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º pytest..."
                        sh 'python -m pytest tests/ -v --junitxml=test-results.xml'
                            
                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç—á–µ—Ç—ã JUnit
                        junit 'test-results.xml'
                    } catch (Exception e) {
                        echo "‚ùå –¢–µ—Å—Ç—ã —É–ø–∞–ª–∏ —Å –æ—à–∏–±–∫–æ–π: ${e.getMessage()}"
                        currentBuild.result = 'FAILURE'
                        throw e
                    }
                }
            }
        }
        
        /*
         * –≠–¢–ê–ü 4: –°–ë–û–†–ö–ê (–û–ü–¶–ò–û–ù–ê–õ–¨–ù–û)
         * –ï—Å–ª–∏ —Ç–µ—Å—Ç—ã –ø—Ä–æ—à–ª–∏, –º–æ–∂–Ω–æ —Å–æ–±—Ä–∞—Ç—å –ø—Ä–æ–µ–∫—Ç
         */
        stage('Build Project') {
            when {
                expression { currentBuild.result == null || currentBuild.result == 'SUCCESS' }
            }
            steps {
                echo "üî® –°–æ–±–∏—Ä–∞–µ–º –ø—Ä–æ–µ–∫—Ç..."
                
                script {
                    if (fileExists('package.json')) {
                        sh 'npm run build'
                    } else if (fileExists('pom.xml')) {
                        sh 'mvn compile -DskipTests'
                    } else if (fileExists('build.gradle')) {
                        sh 'gradle build -x test'  // -x test —á—Ç–æ–±—ã –Ω–µ –∑–∞–ø—É—Å–∫–∞—Ç—å —Ç–µ—Å—Ç—ã –ø–æ–≤—Ç–æ—Ä–Ω–æ
                    }
                }
            }
        }
    }
    
    /*
     * –ü–û–°–¢-–û–ë–†–ê–ë–û–¢–ö–ê - –í–ê–ñ–ù–ê–Ø –ß–ê–°–¢–¨!
     * –ó–¥–µ—Å—å —Ñ–æ—Ä–º–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
     */
    post {
        /*
         * –í–°–ï–ì–î–ê - –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤ –ª—é–±–æ–º —Å–ª—É—á–∞–µ
         */
        always {
            echo "üìã === –û–¢–ß–ï–¢ –û –í–´–ü–û–õ–ù–ï–ù–ò–ò ==="
            echo "üìÅ –ü—Ä–æ–µ–∫—Ç: ${APP_NAME}"
            echo "üåø –í–µ—Ç–∫–∞: dev"
            echo "üîñ –ö–æ–º–º–∏—Ç: ${env.COMMIT_HASH ?: '–Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω'}"
            echo "üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç: ${currentBuild.result ?: 'SUCCESS'}"
            echo "üî¢ –ù–æ–º–µ—Ä —Å–±–æ—Ä–∫–∏: ${env.BUILD_NUMBER}"
            
            // –û—á–∏—â–∞–µ–º —Ä–∞–±–æ—á—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
            cleanWs()
        }
        
        /*
         * –£–°–ü–ï–• - —Ç–µ—Å—Ç—ã –ø—Ä–æ—à–ª–∏ —É—Å–ø–µ—à–Ω–æ
         */
        success {
            echo "‚úÖ ‚úÖ ‚úÖ –¢–ï–°–¢–´ –ü–†–û–ô–î–ï–ù–´ –£–°–ü–ï–®–ù–û!"
            echo "üéâ –í—Å–µ —Ç–µ—Å—Ç—ã –≤ –≤–µ—Ç–∫–µ dev –ø—Ä–æ—Ö–æ–¥—è—Ç"
            echo "üìä –°—Ç–∞—Ç—É—Å: –ì–æ—Ç–æ–≤–æ –∫ –º–µ—Ä–¥–∂ –≤ main"
            
            // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Slack/Email
            // slackSend channel: '#dev', message: "‚úÖ –¢–µ—Å—Ç—ã –≤ dev –ø—Ä–æ—à–ª–∏ —É—Å–ø–µ—à–Ω–æ! –ö–æ–º–º–∏—Ç: ${COMMIT_HASH}"
        }
        
        /*
         * –ü–†–û–í–ê–õ - —Ç–µ—Å—Ç—ã –Ω–µ –ø—Ä–æ—à–ª–∏
         */
        failure {
            echo "‚ùå ‚ùå ‚ùå –¢–ï–°–¢–´ –ù–ï –ü–†–û–®–õ–ò!"
            echo "üö® –í –≤–µ—Ç–∫–µ dev –µ—Å—Ç—å –ø—Ä–æ–±–ª–µ–º—ã!"
            echo "üîß –ù–µ–æ–±—Ö–æ–¥–∏–º–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç—ã –ø–µ—Ä–µ–¥ –º–µ—Ä–¥–∂–µ–º"
            echo "üë§ –ê–≤—Ç–æ—Ä –ø—Ä–æ–±–ª–µ–º–Ω–æ–≥–æ –∫–æ–º–º–∏—Ç–∞: ${COMMIT_AUTHOR ?: '–Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω'}"
            
            // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫—É (—Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π –µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
            // mail to: "${COMMIT_AUTHOR}", subject: "‚ùå –¢–µ—Å—Ç—ã —É–ø–∞–ª–∏ –≤ dev", body: "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å –∫–æ–º–º–∏—Ç ${COMMIT_HASH}"
        }
        
        /*
         * –ò–ó–ú–ï–ù–ï–ù–ò–ï –°–¢–ê–¢–£–°–ê
         */
        changed {
            echo "üîÑ –°—Ç–∞—Ç—É—Å —Å–±–æ—Ä–∫–∏ –∏–∑–º–µ–Ω–∏–ª—Å—è"
            script {
                if (currentBuild.previousBuild) {
                    previousResult = currentBuild.previousBuild.result
                    echo "üìà –ë—ã–ª–æ: ${previousResult}, –°—Ç–∞–ª–æ: ${currentBuild.result}"
                }
            }
        }
    }
}